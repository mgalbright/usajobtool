<!DOCTYPE html>
<html lang="en">
<head>

  <title>Usajobs Search Tool</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--Bootstrap CSS CDN-->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <!--dataTables Bootstrap styling CSS CDN-->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/plug-ins/1.10.7/integration/bootstrap/3/dataTables.bootstrap.css">
</head>


<body>
  <div class="container-fluid">

  <!--Bootstrap navbar at top of page, gives several buttons/views-->

  <nav class="navbar navbar-inverse"> 
  <div class="container-fluid">

    <!--Navbar header-->
    <div class="navbar-header">

      <!--On small devices, the navbar can be collapsed/expanded with
          this tiny button-->
      <button type="button" class="navbar-toggle" data-toggle="collapse" 
         data-target="#pageNavbarCollapse">
         <span class="sr-only">Toggle navigation</span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
      </button>

      <!--Page name (called brand in Bootstrap)-->
      <a class="navbar-brand" href="#">Usajobs Tool</a>
    </div>

    <!--==================navbar body, with navbar buttons==================-->
    <div class="collapse navbar-collapse" id="pageNavbarCollapse">
      <ul class="nav navbar-nav">

        <!--Basic Search view button-->
        <li class="active"><a data-toggle="tab" href="#basicSearchDiv">
          Basic Search</a></li>

        <!--Advanced Search view button-->
        <li><a data-toggle="tab" href="#advancedSearchDiv">Advanced Search</a>
        </li>

        <!--Dropdown Settings button-->
        <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Settings
          <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#" data-toggle="modal" data-toggle="tooltip" 
              data-placement="top" title="Export app settings to JSON string"
              data-target="#exportSettingsModal">Export Settings</a></li>

            <li><a href="#" data-toggle="modal" data-toggle="tooltip" 
              data-placement="top" title="Import app settings from JSON string"
              data-target="#importSettingsModal">Import Settings</a></li>

            <li><a href="#" data-toggle="modal" data-toggle="tooltip" 
              data-placement="top" title="Create custom app settings"
              data-target="#createSettingsModal" >Create Settings</a></li>

            <li><a href="#" id="settingsDefaultBtn" data-toggle="tooltip" 
              data-placement="top" title="Restore app settings to default">
              Use Default Settings</a>
            </li>

            <li role="separator" class="divider"></li>

            <li><a href="#" data-toggle="modal" data-toggle="tooltip" 
              data-placement="top" title="More about this program" 
              data-target="#aboutModal">About</a></li>
          </ul>
        </li>
        
      </ul>
    </div>
  </div>
  </nav>


  <!--Content for tabs in navbar, gives different views-->
  <div class="tab-content">

    <!--Basic search view-->
    <div id="basicSearchDiv" class="tab-pane fade in active">
      <!--Button and keyword input text box, for simple keyword searching-->
      <div class="row">
        <div class="col-lg-6">
          <div class="input-group">

            <span class="input-group-btn">
            <button id="basicSearchBtn" class="btn btn-default" type="button">
            Search</button>
            </span>

            <input id="basicKeywordInputBox" type="text" class="form-control" 
            placeholder="Job keyword">

          </div>
        </div>
      </div>

      <p></p>

      <!--Bootstrap alert, show if error: empty basic search input button-->
      <div class="alert alert-info fade in" id="errorEmptyBasicSearch" 
      style="display: none;">
        <a href="#" class="close" aria-label="close">&times;</a>
        <strong>Warning!</strong> Empty search.
      </div>

    </div>

    <!--Advanced searching view-->
    <div id="advancedSearchDiv" class="tab-pane fade">

      <form>
        <!--Give each input box a special class: advInputBox, use it
          to tell if user presses enter in any one of them.-->

        <!--Keyword input box for advanced search-->
        <div class="form-group">
          <input type="text" class="form-control advInputBox" 
          id="advKeywordInputBox" placeholder="Job keyword">
        </div>

        <!--An input box for job Series code and a dropdown button
            to auto fill it-->
        <div class="form-group">
        <div class="input-group">

          <input type="text" class="form-control advInputBox" 
          id="advSeriesInputBox" 
          placeholder="Job Series code (4-digit number)">

          <div class="input-group-btn">
            <button type="button" class="btn btn-default dropdown-toggle" 
            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Codes<span class="caret"></span></button>
            <ul class="dropdown-menu dropdown-menu-right">
              <li><a href="#" data-jobseries="2210" class="jobSeriesLink">
                2210 (Info Technology)</a></li>

              <li><a href="#" data-jobseries="1500" class="jobSeriesLink">
                1500 (Mathematics)</a></li>

              <li><a href="#" data-jobseries="0800" class="jobSeriesLink">
                0800 (Engineering)</a></li>

              <li><a href="#" data-jobseries="1310" class="jobSeriesLink">
                1310 (Physics)</a></li>

              <li><a href="#" data-jobseries="1320" class="jobSeriesLink">
                1320 (Chemistry)</a></li>

              <li><a href="#" data-jobseries="0400" class="jobSeriesLink">
                0400 (Biology)</a></li>

              <li><a href="#" data-jobseries="0200" class="jobSeriesLink">
                0200 (Human Resources)</a></li>

              <li><a href="#" data-jobseries="0500" class="jobSeriesLink">
                0500 (Accounting)</a></li>

              <!--The URL is set in jQuery, to avoid hardcoding it-->
              <li><a href="#" target="_blank" id="MoreJobSeriesCodesURL">
              More codes</a></li>

            </ul>
          </div>
        </div>
        </div>

        <!--Bootstrap alert, show if invalid job Series code, start hidden-->
        <div class="alert alert-info fade in" id="errorInvalidJobSeries" 
        style="display: none;">
          <a href="#" class="close" aria-label="close">&times;</a>
          <strong>Warning!</strong> Job Series code must be a 4-digit number.
        </div>
          
        <!--City input text box-->
        <div class="form-group">
          <input type="text" class="form-control advInputBox" 
          id="advCityInputBox" placeholder="City name">
        </div>

        <!--Zip code input text box-->
        <div class="form-group">
          <input type="text" class="form-control advInputBox" 
          id="advZipCodeInputBox" placeholder="Zip code">
        </div>

        <!--Advanced Search button-->
        <button id="advSearchBtn" class="btn btn-default" type="button">
        Search</button>

        <p></p>

        <!--Bootstrap alert, show if advanced search is empty, start hidden-->
        <div class="alert alert-info fade in" id="errorEmptyAdvSearch" 
        style="display: none;">
          <a href="#" class="close" aria-label="close">&times;</a>
          <strong>Warning!</strong> Empty search.
        </div>

      </form>
    </div>
  </div>


  <!--Bootstrap alert, show if error connecting to usajobs.gov-->
  <div class="alert alert-danger fade in" id="errorAjaxGetFailed" 
  style="display: none;">
    <a href="#" class="close" aria-label="close">&times;</a>
    <strong>Warning!</strong> Failed to retrieve data from the usajobs.gov 
    server. Check your network connection.
  </div>

  <!--Bootstrap alert, show if HTML5 localStorage is unavailable-->
  <div class="alert alert-danger fade in" id="errorNoLocalStorage" 
  style="display: none;">
    <a href="#" class="close" aria-label="close">&times;</a>
    <strong>Warning!</strong> This page will not be able to remember its 
    settings. Please enable HTML5 localStorage.
  </div>

  <!--Bootstrap alert, show if machine learning settings are corrupted-->
  <div class="alert alert-danger fade in" id="ErrorBadMLSettings" 
  style="display: none;">
    <a href="#" class="close" aria-label="close">&times;</a>
    <strong>Warning!</strong> This site's machine learning settings 
    are corrupted, reverting to default settings.
  </div>

  <p></p>
  
  <!--Table to hold Job results. Starts invisible, show when styled as 
   jQuery dataTable-->
  <div id="divJobsTable" style="display: none;">
  <table id="jobsTable" class="table table-striped" width="100%">
    <thead>
      <tr>
        <th>Score</th>
        <th>Action</th>
        <th>JobTitle</th>
      </tr>
    </thead>
  </table>
  </div>


  <!--======================================================================-->
  <!--Bootstrap modals-->

  <!--Modal to view detailed job description-->
  <div class="modal fade" id="jobInfoModal" tabindex="-1" role="dialog" 
  aria-labelledby="jobInfoModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" 
        aria-label="Close"><span aria-hidden="true">&times;</span></button> 

        <!--==================Modal Title======================-->
        <h4 class="modal-title" id="modal_JI_ModalTitle">Job Details</h4>
        </div>

        <!--===============Summarize job info=============-->
        <div class="modal-body">

          <h4>Title:</h4>
          <p id="modal_JI_JobTitle"></p>

          <h4>Agency:</h4>
          <p id="modal_JI_Agency"></p>  

          <h4>Salary:</h4>
          <p id="modal_JI_Salary"></p>

          <h4>Location:</h4>
          <p id="modal_JI_Location"></p>

          <h4>Description:</h4>
          <p id="modal_JI_JobDescript"></p>
        </div>


        <div class="modal-footer">

        <!--Buttons for user to rate the job-->
        <div class="btn-group pull-left dropup">
        <button type="button" class="btn btn-primary dropdown-toggle" 
        data-toggle="dropdown" aria-expanded="false">
        Rate <span class="caret"></span></button>
        <ul class="dropdown-menu" role="menu">

          <!--====Like and Don't Like buttons====-->
          <li><a href="#" id="modal_JI_Like" data-documentid="">Like</a></li>
          <li><a href="#" id="modal_JI_DontLike" data-documentid="">
          Don't Like</a></li>
        </ul>
        </div>

        <!--Close modal button-->
        <button type="button" class="btn btn-default pull-left" 
        data-dismiss="modal">Close</button>
  
        </div>
      </div>
    </div>
  </div>
  

  <!--Modal giving info about this program-->
  <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" 
  aria-labelledby="aboutModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" 
          aria-label="Close"><span aria-hidden="true">&times;</span></button> 

          <!--Modal Title-->
          <h4 class="modal-title">About</h4>
        </div>

        <!--===============About this program============-->
        <div class="modal-body">
          This site is a cross platform, mobile friendly web app for searching
          <a href="#" id="AboutModalUsajobsHomeLink" 
          target="_blank">usajobs.gov</a>.
          Beyond searching, this page uses
          machine learning (online logistic regression) to rank jobs
          based on job title and summary, then sorts the jobs to
          display the most interesting jobs first.  You may
          rate jobs (like/don't like), and the machine learning
          settings will be updated: the app will learn what kinds
          of jobs you like or don't like.  

          <p></p>

          Details: This page runs entirely locally (in the browser) 
          using javascript, jQuery, and HTML5.  It is
          styled (mobile friendly) using Bootstrap.  
          It obtains its data using the usajobs.gov open 
          <a href="#" id="AboutModalUsajobsDataLink" target="_blank">
          REST API</a>.
          Machine learning settings are stored in HTML5 local storage. 
          You may export/import settings if using this app across multiple 
          devices.
        </div>

        <div class="modal-footer">
          <!--Close modal button-->
          <button type="button" class="btn btn-default pull-left"  
          data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <!--===========Modal to export siteSettings===========================-->
  <div class="modal fade" id="exportSettingsModal" tabindex="-1" 
  role="dialog" aria-labelledby="exportSettingsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" 
          aria-label="Close"><span aria-hidden="true">&times;</span></button> 

          <!--==================Modal title======================-->
          <h4 class="modal-title">Export Settings</h4>
        </div>

        <!--===============Modal output textbox============-->
        <div class="modal-body">
        <form role="form">
          <div class="form-group">
            <label for="Export site settings">Exported site settings 
              (for machine learning).</label>
            <textarea class="form-control" rows="10"
              id="modalExportSettingsBox"></textarea>
          </div>
        </form> 
        </div>

        <div class="modal-footer">
        <!--Close modal button-->
        <button type="button" class="btn btn-default pull-left"  
        data-dismiss="modal">Close</button>
  
        </div>
      </div>
    </div>
  </div>


  <!--===========Modal to import siteSettings===========================-->
  <div class="modal fade" id="importSettingsModal" tabindex="-1" 
  role="dialog" aria-labelledby="importSettingsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" 
          aria-label="Close"><span aria-hidden="true">&times;</span></button> 

          <!--==================Modal title======================-->
          <h4 class="modal-title">Import Settings</h4>
        </div>

        <!--===============Modal settings input textbox============-->
        
        <div class="modal-body">
        <form role="form">
          <div class="form-group">
            <label for="Import site settings">Paste site settings
            (a JSON structure) below.</label>
            <textarea class="form-control" rows="10"
              id="modalImportSettingsBox"></textarea>
          </div>
        </form> 
        </div>
        
        <!--Bootstrap alert, show if input JSON is invalid-->
        <div class="alert alert-info fade in" id="errorBadImportJSONString" 
        style="display: none;">
          <a href="#" class="close" aria-label="close">&times;</a>
          <strong>Warning!</strong> The import settings JSON does not appear
          to be properly formatted.  Import failed.
        </div>


        <div class="modal-footer">

        <!--Import settings button-->
        <button type="button" class="btn btn-primary pull-left" 
        id="modalimportImportBtn">Import</button>

        <!--Close modal button-->
        <button type="button" class="btn btn-default pull-left"  
        data-dismiss="modal">Close</button>
  
        </div>
      </div>
    </div>
  </div>
  

  <!--===========Modal to create siteSettings from good/bad keywords========-->
  <div class="modal fade" id="createSettingsModal" tabindex="-1" 
  role="dialog" aria-labelledby="createSettingsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" 
          aria-label="Close"><span aria-hidden="true">&times;</span></button> 

          <!--==================Modal title======================-->
          <h4 class="modal-title">Create Settings</h4>
        </div>

        <!--===============Modal body============-->
        <div class="modal-body">

        Enter keywords in the boxes below.  These keywords
        will be used in the machine learning code rank and sort jobs.

        Separate the keywords by commas.  
        Try to  use root words (which are more likely to occur)
        like <i>mathemat, data scien</i> instead of 
        <i>mathematician, data scientist</i>.  
        
        <p></p>

        <!--Good keywords-->
        <form role="form">
          <div class="form-group">
            <label for="Create site settings">Enter keywords found
            in jobs you like.</label>
            <textarea class="form-control" rows="4"
              id="modalCreateGoodKWsBox"
              placeholder="mathemat, data scien, computer scien"></textarea>
          </div>
        </form> 

        <!--Bad keywords-->
        <form role="form">
          <div class="form-group">
            <label for="Create site settings">Enter keywords found
            in jobs you don't like.</label>
            <textarea class="form-control" rows="4"
              id="modalCreateBadKWsBox"
              placeholder="bartend, waiter, clerk"></textarea>
          </div>
        </form> 
        </div>
        
        <!--Bootstrap alert, show if input keywords are invalid-->
        <div class="alert alert-info fade in" id="errorBadKeywordStrings" 
        style="display: none;">
          <a href="#" class="close" aria-label="close">&times;</a>
          <strong>Warning!</strong> The keyword strings are not valid.
          Make sure you have entered at least one keyword. Separate
          keywords by commas.
        </div>

        <!--=================================-->

        <div class="modal-footer">

        <!--create settings button-->
        <button type="button" class="btn btn-primary pull-left" 
        id="modalcreateCreateBtn">Create</button>

        <!--Close modal button-->
        <button type="button" class="btn btn-default pull-left"  
        data-dismiss="modal">Close</button>
  
        </div>
      </div>
    </div>
  </div>
  

  <!--======================================================================-->
  <!--CDN's for javascript libraries-->

  <!--jQuery-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

  <!--jQuery dataTables-->
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.js"></script> 

  <!--dataTables Bootstrap styling-->
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/plug-ins/1.10.7/integration/bootstrap/3/dataTables.bootstrap.js"></script> 

  <!--Boostrap javascript-->
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> 
 
  <!--=============================================================-->
  <!--Main code-->
  
  <script>
    /**
    * @fileoverview This code searches usajobs.gov, then sorts jobs 
    * by user interest.
    *
    * This code searches for jobs using the open REST API of usajobs.gov.
    * Then machine learning ranks the jobs, from most to least interesting,
    * and shows the most interesting jobs first.  The user can also
    * rate viewed jobs which updates the machine learning settings, leading
    * to improved predictions in the future.  Machine learning settings
    * are saved between sessions using HTML5 localStorage.
    */

    //=========================================================================
    //Adjustable program constants:

    /**
    * Gradient descent learning rate for machine learning algorithm.
    * Larger values cause faster learning.
    * @const {number}
    */  
    var LEARNING_RATE = 0.35;   

    /**
    * Default weight vector component for good keywords, should be > 0.
    * @const {number}
    */   
    var DEFAULT_GOOD_KEYWORD_WEIGHT = 0.7; 

    /**
    * Default weight vector component for bad keywords, should be < 0.
    * @const {number}
    */   
    var DEFAULT_BAD_KEYWORD_WEIGHT = -0.7; 

    /**
    * Default weight vector component for the bias term, for rating jobs 
    * with no matching keywords.  0 is a good value.
    * @const {number}
    */   
    var DEFAULT_BIAS_WEIGHT =  0.0; 

    /**
    * Auto close JobInfo modal when user rates a job?
    * @const {boolean}
    */  
    var CLOSE_JI_MODAL_AFTER_RATED = true; 

    /**
    * Max number jobs to retrieve from the server at a time?
    * @const {number}
    */ 
    var NUM_JOBS_PER_SEARCH = 100;      

    /**
    * Should the dataTable split the jobs list into multiple pages?
    * @const {boolean}
    */ 
    var DATA_TABLE_PAGINATION = true;

    /**
    * Number of jobs shown in each dataTable page.
    * @const {number}
    */ 
    var DATA_TABLE_PAGE_LENGTH = 25;    


    //Links, I don't hardcode them in case they change.

    /**
    * Link to usajobs.gov homepage.
    * @const {string}
    */ 
    var USA_JOBS_HOME_URL = "https://www.usajobs.gov";

    /**
    * Link to usajobs.gov data API overview page.
    * @const {string}
    */ 
    var USA_JOBS_DATA_URL = "https://data.usajobs.gov";

    /**
    * Link to usajobs.gov search REST interface.
    * @const {string}
    */ 
    var USA_JOBS_SEARCH_URL = "https://data.usajobs.gov/api/jobs?";

    /**
    * Link to the list of US government jobs Series codes.
    * @const {string}
    */ 
    var JOB_SERIES_CODES_URL = "http://www.opm.gov/policy-data-oversight/"+
    "classification-qualifications/general-schedule-qualification-standards/"+
    "#url=List-by-Occupational-Series";

    //=========================================================================
    //Global variables

    /**
    * Stores raw jobs data returned by usajobs.gov search, is an object.
    * @global 
    */ 
    var jobsRawData;

    /**
    * Stores parsed jobs info in searchable hashtable (key is DocumentID).
    * @global 
    */ 
    var jobsInfo = {}; 

    /**
    * Stores app's machine learning settings in memory, is an object.
    * @global 
    */      
    var jSiteSettings;    

    /**
    * Stores stringified copy of jSiteSettings.
    * @global {string}
    */     
    var sSiteSettings = "";   
    
    //=========================================================================
    //jQuery code to make the site interactive

    $(document).ready(function(){

      //Set the clickable links  
      $("#MoreJobSeriesCodesURL").attr("href", JOB_SERIES_CODES_URL);
      $("#AboutModalUsajobsHomeLink").attr("href", USA_JOBS_HOME_URL);
      $("#AboutModalUsajobsDataLink").attr("href", USA_JOBS_DATA_URL);

      //Turn on tooltips, used for Settings buttons
      $('[data-toggle="tooltip"]').tooltip();

      //-----------------------------------------------------------------------

      //Retrieve machine learning settings from localStorage.
      //If load error, or settings look invalid, this restores defaults.
      GetSettingsFromLocalStorage(); 

      //If localStorage unavailable, warn user.
      if(!LocalStorageAvailable()){
        $("#errorNoLocalStorage").show(); 
      }

      //-------------------------------------------------------------
    
      //Search for jobs when user clicks basic search button
      $("#basicSearchBtn").click(function(){

        var searchKeyword = $.trim($("#basicKeywordInputBox").val());
        
        if(searchKeyword.length > 0){
          //get and parse job data
          SearchForJobs(searchKeyword, "", "", ""); 
        }
        else{
          $("#errorEmptyBasicSearch").show();
        }

      });

      //if user presses enter in basic search box, click basic search button
      $('#basicKeywordInputBox').keypress(function(key){
        if(key.which === 13)
          $('#basicSearchBtn').click();
      });

      //Search for jobs when user clicks advanced search button
      $("#advSearchBtn").click(function(){

        //Get search data the user entered
        var searchKeyword = $.trim($("#advKeywordInputBox").val());
        var searchSeries = $.trim($("#advSeriesInputBox").val());
        var searchCity = $.trim($("#advCityInputBox").val());
        var searchZipCode = $.trim($("#advZipCodeInputBox").val());
  
        //Check if Series code looks valid
        var validSeries = ValidateJobSeriesCode(searchSeries);      
        if(searchSeries.length>0 && !(validSeries) ){
          $("#errorInvalidJobSeries").show();  //show Series warning
        }

        if(searchKeyword.length === 0 && searchSeries.length === 0 && 
          searchCity.length === 0 && searchZipCode.length === 0){
          $("#errorEmptyAdvSearch").show(); //show warning: empty search
        }
        else if(validSeries || searchSeries.length===0){
          //Only search if search criteria entered AND 
          //series is either missing or looks valid
          SearchForJobs(searchKeyword, searchSeries, searchCity, 
          searchZipCode);
        }
      });

      //If user presses enter in any advanced search box, 
      //click advanced search button.
      $('.advInputBox').keypress(function(key){
        if(key.which === 13)
          $('#advSearchBtn').click();
      });

      /*In advanced view, if user clicks any job Series code link, 
        place series job Code for that job into the job Series input box.*/
      $(".jobSeriesLink").click(function(){

        var jobSeries = $(this).attr('data-jobseries');

        $('#advSeriesInputBox').val(jobSeries);
      });

      //Hide Bootstrap alerts if user clicked close button.
      $('.alert .close').on('click', function(){
          $(this).parent().hide();
      });

      //When jobInfoModal launches, load data for the requested job into modal.
      $('#jobInfoModal').on('show.bs.modal', function (event){
        var button = $(event.relatedTarget); // Button that triggered the modal
        var docID = button.data('documentid'); // Extract docID from attributes
        
        // Update the modal's content:

        var modal = $(this);

        //set job title:
        modal.find('#modal_JI_JobTitle').html(jobsInfo[docID].link); 

        //set Agency:
        modal.find('#modal_JI_Agency').text(jobsInfo[docID].OrganizationName +
          ', ' +  jobsInfo[docID].AgencySubElement);

        //set salary:
        modal.find('#modal_JI_Salary').text(jobsInfo[docID].SalaryMin +
          '-' + jobsInfo[docID].SalaryMax + ' ' +
          jobsInfo[docID].SalaryBasis);

        //set location(s):
        modal.find('#modal_JI_Location').text(jobsInfo[docID].Locations);

        //set job summary
        modal.find('#modal_JI_JobDescript').text(jobsInfo[docID].JobSummary);

        //Update the like/don't like button's data-documentid attribute so that
        //when the button is clicked, the correct documentid is passed to
        //the the online machine learning algorithm.
        modal.find('#modal_JI_Like').attr('data-documentid',docID);
        modal.find('#modal_JI_DontLike').attr('data-documentid',docID);
        
      });

      //When modal opens for exporting siteSettings, show settings
      $('#exportSettingsModal').on('show.bs.modal', function (){

        var modal = $(this);

        //Show settings:
        modal.find('#modalExportSettingsBox').text(sSiteSettings);
      });

      //User clicked to import site settings (JSON string), save them
      $("#importSettingsModal").on("click", "#modalimportImportBtn", 
      function(){

        var sJSONSettings = $('#modalImportSettingsBox').val();
        var jJSONSettings;

        try{
          jJSONSettings = DecodeSettingsJSONString(sJSONSettings);
        }
        catch(error){
          $('#errorBadImportJSONString').show();
          return; //break early
        }

        //Update current settings to use imported settings if can   
        SaveNewSiteSettings(jJSONSettings);
             
        /*If jobsRawData defined, then we need to re-parse and re-sort jobs
          with the new machine learning settings.  */
        if(jobsRawData  && typeof jobsRawData !== 'undefined' ){
          ParseJobsData();
        }

        $('#importSettingsModal').modal("hide");
      });

      //User clicked to create site settings
      $("#createSettingsModal").on("click", "#modalcreateCreateBtn", 
      function(){

        var goodWordStr = $('#modalCreateGoodKWsBox').val();
        var badWordStr = $('#modalCreateBadKWsBox').val();
        
        var dataObject;

        try{
          dataObject = BuildSiteSettingsFromKeywords(goodWordStr, badWordStr);
        }
        catch(error){
          $("#errorBadKeywordStrings").show(); //show warning  
          return;  //break
        }

        //Update settings and save to localStorage if available
        SaveNewSiteSettings(dataObject); 

        /*If jobsRawData defined, then we need to re-parse and re-sort jobs
          with the new machine learning settings.  */
        if(jobsRawData  && typeof jobsRawData !== 'undefined' ){
          ParseJobsData();
        }

        $('#createSettingsModal').modal("hide");
      });

      //user clicked to reset site settings to default
      $('#settingsDefaultBtn').on('click', function(){
        SetSiteDefaultSettings();

        /*If jobsRawData defined, then we need to re-parse and re-sort jobs
          with the new machine learning settings.  */
        if(jobsRawData  && typeof jobsRawData !== 'undefined' ){
          ParseJobsData();
        }

      });
      
      //User clicked a rate button: they like the job
      $("#jobInfoModal").on("click", "#modal_JI_Like", function(){
        var docID = $('#modal_JI_Like').attr('data-documentid');
        
        //Update machine learning settings: the user liked this job
        RateJob(docID, true);

        /*Machine learning settings changed, re-sort jobs.  */
        if(jobsRawData  && typeof jobsRawData !== 'undefined' ){
          ParseJobsData();
        }

        if(CLOSE_JI_MODAL_AFTER_RATED){
          $('#jobInfoModal').modal("hide");
        }
      });

      //User clicked a rate button: they didn't like the job
      $("#jobInfoModal").on("click", "#modal_JI_DontLike", function(){
        var docID = $('#modal_JI_Like').attr('data-documentid');

        //update machine learning settings: the user didn't like this job
        RateJob(docID, false);

        /*Machine learning settings changed, re-sort jobs.  */
        if(jobsRawData  && typeof jobsRawData !== 'undefined' ){
          ParseJobsData();
        }

        if(CLOSE_JI_MODAL_AFTER_RATED){
          $('#jobInfoModal').modal("hide");
        }
      });

    });

    //=========================================================================
    //Javascript functions

    /**
     * Checks if searchSeries looks like a valid job Series code.
     *
     * @param {string} searchSeries A job Series code for the Federal 
     *        government. Should be 4 characters of integers.
     * @return true if searchSeries looks like a valid code, else false.
     */
    function ValidateJobSeriesCode(searchSeries){
      //Check if searchSeries contains exactly 4 digits, nothing else
      var RegExPattern = /^[0-9]{4}$/;   

      if(searchSeries.match(RegExPattern)){
        return true; //Series looks valid
      }
      else{
        return false;
      }
    }

    /** 
     * Builds site's machine learning settings and saves to local storage.
     *
     * Given 2 strings containing comma-separated good and bad job keywords, 
     * split each string into an array of keywords, then create machine
     * learning settings from those keywords. (These settings are 
     * used to build feature vectors for jobs when analyzing job titles 
     * and summaries.) Returns data structure with array of good keywords and
     * array of machine learning weights.      
     *
     * @param {string} goodKeywordsString Contains keywords found in
     *        good jobs. Keywords should be separated by commas.           
     * @param {string} badKeywordsString Contains keywords found in
     *        bad jobs. Keywords should be separated by commas.
     * @returns An object with elements keywords, weights, which are both 
     *          arrays.
     * @throws A string error message if keyword strings empty or invalid.
     * @throws A string error message if weights.length != keywords.length 
     *          + 1.
     */
    function BuildSiteSettingsFromKeywords(goodKeywordsString, 
    badKeywordsString){

      //want keywords lowercase
      goodKeywordsString = goodKeywordsString.toLowerCase();
      badKeywordsString = badKeywordsString.toLowerCase();

      //Split string on commas into individual keywords
      var regExSplitPattern = /\s*,\s*/;  

      var goodList = goodKeywordsString.split(regExSplitPattern);
      var badList = badKeywordsString.split(regExSplitPattern);

      var newSettings = {"keywords":[], "weights":[]};

      /*This weight correspongs to the bias term.  
        Its meaning: what dot product value should we give a job that contains
        no keywords, good or bad.  >0 means a job with no keywords is assumed
        good. 0 means neutral. <0 means assume it is bad.*/
      newSettings.weights.push(DEFAULT_BIAS_WEIGHT);

      //Add all valid (good, bad) keywords and default weights to newSettings
      var word = "";
      var i;
      for(i = 0; i < goodList.length; i++){ 
        word = $.trim(goodList[i]);

        if(word.length > 0){
          newSettings.keywords.push(word);
          newSettings.weights.push(DEFAULT_GOOD_KEYWORD_WEIGHT);
        } 
      }

      for(i = 0; i < badList.length; i++){ 
        word = $.trim(badList[i]);

        if(word.length > 0){
          newSettings.keywords.push(word);
          newSettings.weights.push(DEFAULT_BAD_KEYWORD_WEIGHT);
        } 
      } 

      if(newSettings.keywords.length === 0)
        throw "No valid keywords entered for ranking jobs.";

      if(newSettings.weights.length !== newSettings.keywords.length +1)
        throw "In settings, keyword and weight lengths mismatch.";

      return newSettings;     
    }

    /**
     * Saves current site machine learning settings to localStorage.
     *
     * From settingsData, update global variables jSiteSettings and 
     * sSiteSettings and save new settings to localStorage if can.
     *
     * @param settingsData Is object with array elements keywords, weights.
     */
    function SaveNewSiteSettings(settingsData){
      //Do a bit of extra validation, in case input is invalid
      if(('keywords' in settingsData) && ('weights' in settingsData) &&
      (settingsData.weights.length == settingsData.keywords.length + 1)){

        try{
          //update memory first, in case localStorage causes errors
          jSiteSettings = settingsData;
          sSiteSettings = JSON.stringify(jSiteSettings); 

          //update local storage if localStorage available
          localStorage.clear(); 
          localStorage.setItem("siteSettingsData", sSiteSettings); 
        }
        catch(error){
          return;
        } 
      }
      else{
        return;
      }
    }

    /**
     * Create and save default settings for the machine learning system.
     *
     * This is called if no current settings are saved or if they
     * are corrupted and must be reset. Settings are stored in
     * HTML5 localStorage if it's available, else just in memory.
     */
    function SetSiteDefaultSettings(){
      var goodKeywords, badKeywords;

      goodKeywords = 
        "comput, code, algorithm, software, c++, python, javascript, " + 
        "program, matlab, supercomput, cluster, hpc, mpi, openmp, linux, " +
        "unix, neural net, machine learn, analytics, data, technology, " + 
        "modeling, simulation, research, operations research, econom, " + 
        "statistic, information tech, engineer, scientist, " +
        "analyst, math, mathematician, physic, physicist, " +
        "computer scien, data scien, data engineer";

      badKeywords = "bartender, waiter, food, beverage, clerk, cashier," + 
        " hotel, technician, medical physic, health physic, medical"; 

      var settingsData;

      try{
        settingsData = BuildSiteSettingsFromKeywords(goodKeywords,badKeywords);
      }
      catch(error){
        //failed for some reason, so use a minimal structure to recover
        settingsData = {"keywords":["job"], "weights":[DEFAULT_BIAS_WEIGHT, 
          DEFAULT_GOOD_KEYWORD_WEIGHT]};
      }

      //Update global variables, update localStorage if can
      SaveNewSiteSettings(settingsData); 
    }

    /**
     * Try to parse a JSON string w/ the app settings, throw exception if 
     * error occurs.
     *
     * Throws expection if jsonString is empty, fails to parse, or decodes
     * into something that is not a properly formatted settings object.
     *
     * @param {string} jsonString A string containing a JSON structure holding
     *        the app's machine learning settings.
     * @returns Decoded object, should have array elements keywords, weights.
     * @throws Throws exceptions if fails to parse the jsonString.
     */
    function DecodeSettingsJSONString(jsonString){
      jsonString = $.trim(jsonString);

      if(jsonString.length === 0)
        throw "JSON string is empty.";

      var jsonObject = JSON.parse(jsonString); //try to parse

      if(('keywords' in jsonObject) && ('weights' in jsonObject) &&
      (jsonObject.weights.length == jsonObject.keywords.length + 1)){
        //Looks ok
        return jsonObject;
      }     
      else{
        throw 'JSON string could not be decoded, must be invalid.';
      }
    }

    /**
     * Return true if HMTL5 localStorage is available, else false.
     */  
    function LocalStorageAvailable(){
      var test = 'test';  
      try{
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
      } catch(error){
          return false;
      }
    }

    /**
     * Loads settings from localStorage, use defaults if fails.
     *
     * If localStorage unavailable, will load defaults into memory.
     * If saved settings look invaild, will restore default settings.     
     */
    function GetSettingsFromLocalStorage(){
      if(!LocalStorageAvailable()){
        //No local storage, loads default settings into memory
        SetSiteDefaultSettings();
      }
      else{
        var sSettings, jSettings;

        //Try to decode the settings, check if settings look valid
        try{
          sSettings = localStorage.getItem('siteSettingsData');

          //Note: this will throw exception if settings look invalid
          jSettings = DecodeSettingsJSONString(sSettings);

          //update global variables
          jSiteSettings = jSettings;
          sSiteSettings = sSettings;
        }
        catch(error){
          //Failed to load valid settings, so restore defaults
          SetSiteDefaultSettings();
        }
      }
    }

    /**
     * Retrieve job info from usajobs.gov server.
     *
     * Use jQuery HTTP GET and the usajobs.gov REST API to pull in
     * job results.  Store results in the global variable jobsRawData.
     * If successful, call function ParseJobsData().
     * If fail, show user an alert to check their network.
     *
     * NOTE: Not all arguments are needed.  If an argument is blank,
     * simply pass a blank string like "".
     *
     * @param {string} searchKeyword A keyword to search for in job descrips.
     * @param {string} seriesCode 4-charater string of digits.
     * @param {string} city City name.
     * @param {string} zipCode 5 character string of digits for US zipcode.
     */
    function SearchForJobs(searchKeyword, seriesCode, city, zipCode){
      var params = {"NumberOfJobs": NUM_JOBS_PER_SEARCH};

      //Extra error checking, only proceed if have search argument(s)
      if(searchKeyword.length>0 || seriesCode.length>0 ||
      city.length>0 || zipCode.length>0){ 

        //If present, load data into params object
        if(searchKeyword.length>0)
          params.Keyword = searchKeyword;
        if(seriesCode.length>0)
          params.Series = seriesCode;
        if(city.length>0)
          params.LocationName = city;
        if(zipCode.length>0)
          params.LocationID = zipCode; 

        //use jQuery GET operation to retrieve job data from server
        $.get(USA_JOBS_SEARCH_URL, params)
        .done(function( data ){

          //Store raw jobs data, in case we need again later
          //(For example, if machine learning settings change, then
          //need to re-sort data)
          jobsRawData = data;   

          ParseJobsData();  //process job data, load into dataTable

        })
        .fail(function(x){
          //Ajax get() failed to retrieve data from usajobs.gov,
          //so show error alert.
          $("#errorAjaxGetFailed").show(); 
        });
      }
    }

    /** Process the jobs data retrieved from the usajobs.gov server.
     *
     * Extracts info from data object, then uses machine learning
     * to rank each job from most interesting to least interesting.
     * Then loads sorted list of jobs into the dataTable.
     * For details on the JSON structure returned by usajobs.gov, see
     * https://data.usajobs.gov/Rest.
     *
     * Note: uses global variable jobsRawData: an object storing
     * raw data returned from usajobs.gov.  jobsRawData is set inside
     * SearchForJobs().
     */
    function ParseJobsData(){
      var jobsList = jobsRawData.JobData;  //temp copy of jobs data

      var i, jobslen;
      var line, jobDescrip, prob;

      var keywordIndices;

      jobslen = jobsList.length;

      for(i = 0; i < jobslen; i++){
        //Rank jobs based on job description
        jobDescrip = jobsList[i].JobTitle + " " + jobsList[i].JobSummary;

        /*Build the feature vector for this job using the current machine
          learning settings.  Note feature vector is sparse--only store
          indices of non-zero components.*/
        keywordIndices = BuildFeatureVector(jobDescrip);

        /*Probability user will like this job, using feature vector.*/
        prob = ScoreText(keywordIndices);
        jobsList[i].prob = prob;
        jobsList[i].formattedScore = prob.toFixed(3);//Formatted for display

        //Append a clickable URL to full job description at usajobs.gov:
        jobsList[i].link = '  <a href="' + jobsList[i].ApplyOnlineURL + 
        '" target="_blank" > ' + jobsList[i].JobTitle + '</a>  ';

        /*For each job, create html code for an action button. Clicking
          the button will launch a modal which stores info on the job.
          Note: data-DocumentID stores the DocumentID, so the modal can load
           the correct job info.  Note class modalLauncher.*/
        jobsList[i].action = '<button type="button" '+
        'data-target="#jobInfoModal" '+
        'data-documentid="' + jobsList[i].DocumentID + '" class="btn-xs '+
        'btn-primary modalLauncher" data-toggle="modal">View</button>';

        /*Build searchable jobsInfo hashtable, uses DocumentID as key.
          Then View buttons can grab the job data here using DocumentID.*/
        jobsInfo[ jobsList[i].DocumentID ] = {
          'prob' : jobsList[i].prob,
          'keywordIndices' : keywordIndices,
          'Series' : jobsList[i].Series,
          'OrganizationName' : jobsList[i].OrganizationName,
          'AgencySubElement' : jobsList[i].AgencySubElement,
          'SalaryMin' : jobsList[i].SalaryMin,
          'SalaryMax' : jobsList[i].SalaryMax,
          'SalaryBasis' : jobsList[i].SalaryBasis,
          'Locations' : jobsList[i].Locations,
          'JobSummary' : jobsList[i].JobSummary,
          'ApplyOnlineURL' : jobsList[i].ApplyOnlineURL,
          'link' : jobsList[i].link
        };
      }
   
      //now sort jobs by probability user will like the job, from high to low
      jobsList.sort(function(a,b) { return b.prob - a.prob; } );

      //Now fill dataTable      
      var t = $('#jobsTable').DataTable( {
        "searching": false,
        "paging":    DATA_TABLE_PAGINATION, //Can be toggled true/false
        "pageLength": DATA_TABLE_PAGE_LENGTH,
        "ordering":  false,
        "retrieve":  true, //If data table already initialized, 
                           //don't reinitialize--can only call constructor 
                           //once--so just return dataTable existing object
        "columns": [
          { "width": "9%", "data": "formattedScore" },   
          { "width": "9%", "data": "action" },
          { "width": "82%", "data": "link" } //link is in jobsList[i].link
        ]
      } );
      
      t.clear();              //clear table, if not empty
      t.rows.add(jobsList)    //Now load data and redraw
        .draw();  

      //show dataTable
      $('#divJobsTable').show();
    }

    /**
     * Builds sparse feature vector by analyzing text.
     *
     * Scan through the text = title + job description for keywords, then 
     * build a sparse feature vector: store indices of keywords which
     * were present in the text. 
     *     
     * Example: if keywordIndices[0] == 5, this means the first keyword 
     * present in this job description is the keyword stored in
     * jSiteSettings.keywords[5]. 
     *
     * @param {string} text Job title + job description, text used to rate the 
     *        job.
     * @returns keywordIndices Array storing indices of keywords present
     *          in text.                
     */
    function BuildFeatureVector(text){
      text = text.toLowerCase();

      var keywordIndices = [];

      var NumKeys = jSiteSettings.keywords.length;

      var keyword;
      var stringPos = -1;

      for(var i = 0; i < NumKeys; i++){
        keyword = jSiteSettings.keywords[i];

        stringPos = text.indexOf(keyword); 
        if(stringPos > -1){
          //the keyword is present in the job description, so 
          //save this keyword index
          keywordIndices.push(i);
        }
      }
      return keywordIndices;
    }

    /**
     * Compute dot product between a feature vector and the weight vector.
     *
     * Note: technically, the feature vector components X[i] === 1.0 if the
     * keyword is present, === 0.0 if not. I use a sparse representation so
     * just store the indices of nonzero X[i] components in the array
     * keywordIndices.
     *
     * @param keywordIndices Array storing integer indices of keywords present
     *        in text.
     * @returns Dot product, a real number.
     */  
    function DotProduct(keywordIndices){
      var dotProduct = 0.0; 

      //Handle the bias term: the first feature vector element is
      //implicitly 1.0:
      dotProduct = jSiteSettings.weights[0];
      var index;

      for(var i = 0; i < keywordIndices.length; i++){
        index = keywordIndices[i];

        //X[i] is 1.0 for keywords present, 0.0 else. 
        //Note: (index+1) is because weight[0] is the bias term
        dotProduct += 1.0 * jSiteSettings.weights[index+1];
      }

      return dotProduct;
    }

    /**
     * Probability user likes a job. (Logistic regression sigmoid function.)
     *
     * @param {number} dotProduct A real number, should be the dot product 
     *        between the current weight vector (which stores the app's 
     *        machine learning settings) and a job's feature vector.
     * @returns Probability, real number 0-1.
     */  
    function LogRegProb(dotProduct){ 
      var prob = 1.0/(1.0 + Math.exp(-dotProduct)); 

      return prob;
    }

    /**
     * Computes probability user likes job, given a feature vector.
     *
     * @param keywordIndices Array of integers holding indices of non-zero
     *        elements of feature vector.  (A sparse representation of the 
     *        feature vector of a job.)        
     * @returns A real number 0-1.
     */
    function ScoreText(keywordIndices){
      //Compute dot product between weight and feature vector
      var dotProd = DotProduct(keywordIndices);

      //Chance a user likes this job, float between 0 and 1
      var prob = LogRegProb(dotProd);  

      return prob;
    }

    /**
     * Updates machine learning settings when user rates a job.
     *
     * @param documentID ID number for this job.
     * @param likeJob true if user likes job, else false.
     */
    function RateJob(documentID, likeJob){
      //Predicted probability that the user would like this job
      var ProbLR = jobsInfo[documentID].prob;

      //Indices of keywords that appeared in this job description.
      var keywordIndices = jobsInfo[documentID].keywordIndices;

      var y = 0.0;   
      if(likeJob){
        y = 1.0;    
      }

      //Update machine learning algorithm weights
      OnlineLRUpdateWeights(keywordIndices, ProbLR, y);
    }

    /**
     * Updates weight vector for online logistic regression with job rating.
     *
     * Uses online gradient descent learning algorithm. Updates weights
     * each time a user rates a job.
     *
     * @param keywordIndices Array of indices of nonzero elements of feature
     *        vector for a job (for sparse representation).
     * @param ProbLR Logistic regression classifier's predicted probability
     *        that user likes this job, real number 0-1.     
     * @param y Is the user's job rating (the training data): is 1.0 if the 
     *        user liked the job, 0.0 if not.
     */
    function OnlineLRUpdateWeights(keywordIndices, ProbLR, y){

      /* Weight vector update formula is
        weight[i] -= LEARNING_RATE*X[i]*(ProbLR - y)
      but X[i] is 1 or 0, so only update weights with X[i] = 1. Those
      indices of i (with X[i] != 0) are stored in keywordIndices array.
      (This is a sparse representation to save memory and time.) */

      //Common math factor:
      var factor = LEARNING_RATE*(ProbLR - y);

      //Update bias term
      jSiteSettings.weights[0] -= factor;

      //Loop over indices of non-zero feature vector elements, which have val 1
      for(var i = 0; i < keywordIndices.length; i++){
        jSiteSettings.weights[keywordIndices[i]+1] -= factor;
      }

      //Save these updated settings to localStorage if can  
      SaveNewSiteSettings(jSiteSettings);
    }

  </script>

</body>
</html>
